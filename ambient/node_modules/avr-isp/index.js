function e(e){return e>=48&&e<=57?e-48:e>=65&&e<=70?e-65+10:void 0}function t(e,t){return new ISP(e,t)}var r=require("tessel"),n=require("sync-queue"),o=require("fs"),i=125e3,u=2e6,s={lock:255,low:226,high:223,ext:255},f={lock:255,low:255,high:255,ext:255},a=1,c=0,l=!1;ISP=function(e,t){this.chipSelect=e.digital[0].output().high(),this.reset=e.digital[1].output().high(),this.spi=new e.SPI({clockSpeed:i,mode:0}),this.success=r.led[0],this.programming=r.led[1],t=t||{},this.pageSize=t.pageSize||64,this.fname=t.fileName||"./attx4.hex",this.clockSpeed=i,this.incorrect=0},ISP.prototype._clockChange=function(e){this.clockSpeed!=e&&(this.clockSpeed=e,this.spi.setClockSpeed(e))},ISP.prototype.readSignature=function(e){var t,r=this;l&&console.log("Reading signature"),r.startProgramming(function(n){n?e(n):r._transfer([48,0,0,0],function(){r._transfer([48,0,1,0],function(n,o){l&&console.log("signature 1",o[3]),t=o[3]<<8,r._transfer([48,0,2,0],function(r,n){return l&&console.log("signature 2",n[3]),t|=n[3],l&&console.log("got signature",t),0==t||65535==t?e("Could not find a signature",t):e(null,t)})})})})},ISP.prototype.verifyFuses=function(e,t,r){var o=this;(new n).place(function(){o._transfer([80,0,0,0],function(e,n){return n[3]&t.low?r():r(Error("Could not verify low fuse"))})})},ISP.prototype.programFuses=function(e){var t=this;(new n).place(function(){t._transfer([172,160,0,s.low],function(){t.verifyFuses(s,f,function(r){t.endProgramming(function(){r?e(r):e()})})})})},ISP.prototype.readPagesFromHexFile=function(e){var t=this;o.readFile(t.fname,function(r,n){var o,i,u;r?(l&&console.log("File read error!",r),e(r)):(o={position:-1},i=0,u=[],function r(s){s.position<n.length?(o=t._readImagePage(o.position,n,i),u.push({pageBuffer:o.page,address:i}),i+=t.pageSize,setImmediate(function(){r(o)})):e(null,u)}(o))})},ISP.prototype._readImagePage=function(t,r,n){function o(){u=e(r[++t]),u=(u<<4)+e(r[++t]),s+=u}var i,u,s,f,a,c=this,p=0,g=r,h=[];for(f=0;f<c.pageSize;f++)h[f]=255;for(;;){if(58!=r[++t])return void(l&&console.log("no colon, stopping image read"));if(i=e(r[++t]),i=(i<<4)+e(r[++t]),s=i,l&&console.log("Len",i),o(),a=u,o(),(a=(a<<8)+u)>=n+c.pageSize)return console.log("Error: line address bigger than pages",a),g;if(o(),1==u){l&&console.log("EOF record: 0x1"),t=r.length;break}for(l&&(console.log("line address = 0x",a),console.log("page address = 0x",n)),f=0;f<i;f++)if(o(),h[p]=u,++p>c.pageSize){console.log("Error: too much code");break}if(o(),s%256!=0&&console.log("Error: bad checksum. Got",s),t++,13!=r[t]){if(10!=r[t]){console.log("Error: no end of line");break}}else if(10!=r[++t]){console.log("Error: no end of line");break}if(l&&console.log("page idx",p),p==c.pageSize)break}return l&&console.log("Total bytes read:",p),{position:t,page:new Buffer(h)}},ISP.prototype.flashImage=function(e,t){var r,o=this,i=new n,u=[];for(r=0;r<e.length;r++)i.place(function(r){l&&console.log(r,e[r].pageBuffer),u.push(o._queuePage(e[r].pageBuffer,e[r].address)),r+1<e.length?i.next():o.startProgramming(function(){o._flashAll(u,t)})}.bind(this,r))},ISP.prototype._flashAll=function(e,t){l&&console.log("starting flash");var r=this;e.length?this.spi.send(new Buffer(e[0]),function(){e.shift(),r._flashAll(e,t)}):r.endProgramming(function(){t()})},ISP.prototype._queuePage=function(e,t){var r,o,i=this,u=(new n,[]);for(r=0;r<i.pageSize/2;r++)if(o=r+t/2,u.push(64,o>>8&255,255&o,e[2*r]),u.push(72,o>>8&255,255&o,e[2*r+1]),r+1==i.pageSize/2)return t=t/2&65535,u.push(76,t>>8&255,255&t,0),u},ISP.prototype.verifyImage=function(e,t){var r,o=this,i=new n;for(o.incorrect=0,r=0;r<e.length;r++)i.place(function(r){o._readPage(e[r].pageBuffer,e[r].address,function(){r+1<e.length?i.next():t(null,o.incorrect)})}.bind(this,r))},ISP.prototype._readPage=function(e,t,r){var o,i=this,u=new n;for(o=0;o<i.pageSize/2;o++)u.place(function(n){i._readWord(c,n+t/2,e[2*n],function(){i._readWord(a,n+t/2,e[2*n+1],function(){n+1<i.pageSize/2?u.next():r()})})}.bind(this,o))},ISP.prototype._readWord=function(e,t,r,n){var o=this;l&&console.log("data",r),this._transfer([32+8*e,t>>8&255,255&t,0],function(e,i){r!=i[3]?(l&&console.log("Error verifying data. Expected",r,", got",i[3],"at 0x",t.toString(16)),o.incorrect++,n(e,i)):n(e,i)})},ISP.prototype.startProgramming=function(e){var t=this;t.reset.write(1),setTimeout(function(){t.reset.write(0),t.programming.write(1),t.spi.transfer(new Buffer([172,83,0,0]),function(t,r){l&&console.log("SPI response",r),r&&83==r[2]?e():e(Error("Programming confirmation not received."))})},50)},ISP.prototype.endProgramming=function(e){this.reset.write(1),this.programming.write(0),e()},ISP.prototype.eraseChip=function(e){var t=this;t._transfer([172,128,0,0],function(){l&&console.log("sent erase, waiting for done signal"),t._busyWait(function(){e()})})},ISP.prototype.readEEPROM=function(e,t,r){var o,i=new Buffer(e),u=new n;for(o=0;o<e;o++)u.place(function(n){this.readEEPROMByte(t+n,function(t,o){if(t){if(r)return void r(t)}else i[n]=o,n==e-1?r&&r(null,i):u.next()})}.bind(this,o))},ISP.prototype.writeEEPROM=function(e,t,r){var o,i=new n;for(o=0;o<e.length;o++)i.place(function(n){this.writeEEPROMByte(e[n],t+n,function(t){if(t)return void(r&&r(t));n==e.length-1?r&&r(null):i.next()})}.bind(this,o))},ISP.prototype.readEEPROMByte=function(e,t){this.accessEEPROMByte(160,e,0,t)},ISP.prototype.writeEEPROMByte=function(e,t,r){this.accessEEPROMByte(192,t,e,r)},ISP.prototype.accessEEPROMByte=function(e,t,r,n){var o=this;o.startProgramming(function(i){if(i)return void(n&&n(i));o._transfer([e,0,t,r],function(e,t){if(e)return void(n&&n(e));o.endProgramming(function(e){n&&n(e,t&&t[3])})})})},ISP.prototype._transfer=function(e,t){if(e.length%4!=0){var r="isp transfer called with wrong size. needs to be 4 bytes, got "+e;return console.log(r),t(r)}l&&console.log(e.map(function(e){return e.toString(16)})),this.spi.transfer(new Buffer(e),function(e,r){t(null,r)})},ISP.prototype._busyWait=function(e){var t=this;this.spi.transfer(new Buffer([240,0,0,0]),function(r,n){return 1&n[3]?t._busyWait(e):e()})},module.exports.ISP=ISP,module.exports.FUSES=s,module.exports.MASK=f,module.exports.use=t;