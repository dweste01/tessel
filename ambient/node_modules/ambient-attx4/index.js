function e(e,t){var r,n;this.attiny=new o(e),this.connected=!1,this.lightTriggerLevel=null,this.soundTriggerLevel=null,this.pollingFrequency=500,this.lightPolling=!1,this.soundPolling=!1,this.pollInterval=void 0,r=this,n={firmwareFile:s,firmwareVersion:_,moduleID:i,signature:u,crc:v},r.attiny.initialize(y,n,function(e){e?t?t(e):r.emit("error",e):(r.connected=!0,r.on("newListener",function(e){r.listeners(e).length||r._setListening(!0,e)}),r.on("removeListener",function(e){r.listeners(e).length||r._setListening(!1,e)}),setImmediate(function(){r.emit("ready"),r.irqwatcher=r._fetchTriggerValues.bind(r),r.attiny.setIRQCallback(r.irqwatcher)}),t&&t(null,r))})}function t(t,r){return t||console.warn(Error("Improperly specified Tessel port.")),new e(t,r)}var r=require("util"),n=require("events").EventEmitter,o=global.IS_TEST_ENV?require("./test/common/attiny-common-mock"):require("attiny-common"),i=8,u=37383,s=__dirname+"/firmware/src/ambient-attx4.hex",a=20,f=2,l=1024,c=85,p=22,g=2,h=3,d=4,m=5,E=6,_=3,v=7861,y=100;r.inherits(e,n),e.prototype._fetchTriggerValues=function(){var e=this,t=new Buffer([E,0,0,0,0,0]);e.attiny.transceive(t,function(t,r){var n,o,i;e.attiny._validateResponse(r,[c,E])?(n=new Buffer(r.slice(2,r.length)),o=e._normalizeValue(n.readUInt16BE(0)),i=e._normalizeValue(n.readUInt16BE(2)),o&&e.lightTriggerLevel&&e.emit("light-trigger",o),i&&e.soundTriggerLevel&&e.emit("sound-trigger",i),setImmediate(function(){e.irqwatcher=e._fetchTriggerValues.bind(e),e.attiny.setIRQCallback(e.irqwatcher)})):console.warn("Warning... Invalid trigger values fetched...")})},e.prototype._getSingleDatum=function(e,t){this._readBuffer(e,f,t)},e.prototype._normalizeBuffer=function(e){var t,r=e.length/2,n=Array(r);for(t=0;t<r;t++)n[t]=this._normalizeValue(e.readUInt16BE(2*t));return n},e.prototype._normalizeValue=function(e){return e/l},e.prototype._pollBuffers=function(e){var t=this;t.connected||t._establishCommunication(5,function(e){e&&t.emit("error",Error("Can't communicate with Ambient module..."))}),t.lightPolling&&t.getLightBuffer(e),t.soundPolling&&t.getSoundBuffer(e)},e.prototype._readBuffer=function(e,t,r){var n,o,i=this,u=new Buffer([e,t/2,0]),s=new Buffer(t);s.fill(0),n=new Buffer(1),n.writeUInt8(p,0),o=Buffer.concat([u,s,n]),i.attiny.transceive(o,function(n,o){var s,a;if(i.attiny._validateResponse(o,[c,e,t/2])&&o[o.length-1]===p)return o=i._normalizeBuffer(o.slice(u.length,o.length-1)),1===o.length&&(o=o[0]),s=e===g?"light":"sound",i.emit(s,o),r&&r(null,o),o;a=Error("Invalid response from Ambient module"),r&&r(a)})},e.prototype._setListening=function(e,t){var r,n=this;if("light"===t)this.lightPolling=e;else{if("sound"!==t)return;this.soundPolling=e}("light"===t&&!this.soundPolling||"sound"===t&&!this.lightPolling)&&(r=function(){n._pollBuffers(function(){n._pollTimeout=setTimeout(r,n.pollingFrequency)})},e&&!n._pollTimeout?r():!e&&n._pollTimeout&&(clearTimeout(n._pollTimeout),n._pollTimeout=null))},e.prototype.disable=function(){this._setListening(!1,"light"),this._setListening(!1,"sound")},e.prototype._setTrigger=function(e,t,r){var n,o,i=this;t=Math.ceil(t*l),n=new Buffer(2),n.writeUInt16BE(t,0),o=new Buffer([e,n.readUInt8(0),n.readUInt8(1),0]),i.attiny.transceive(o,function(o,u){if(i.attiny._validateResponse(u,[c,e,n.readUInt8(0),n.readUInt8(1)])){var s=e===d?"light-trigger-set":"sound-trigger-set";return e===d?i.lightTriggerLevel=t:i.soundTriggerLevel=t,i.emit(s,t/l),r&&r(null,t/l),t}r&&r(Error("Invalid response from Ambient module for trigger set."))})},e.prototype.clearLightTrigger=function(e){this.setLightTrigger(0,e)},e.prototype.clearSoundTrigger=function(e){this.setSoundTrigger(0,e)},e.prototype.getLightBuffer=function(e){this._readBuffer(g,a,e)},e.prototype.getLightLevel=function(e){this._getSingleDatum(g,e)},e.prototype.getSoundBuffer=function(e){this._readBuffer(h,a,e)},e.prototype.getSoundLevel=function(e){this._getSingleDatum(h,e)},e.prototype.setLightTrigger=function(e,t){this._setTrigger(d,e,t)},e.prototype.setSoundTrigger=function(e,t){this._setTrigger(m,e,t)},exports.Ambient=e,exports.use=t;